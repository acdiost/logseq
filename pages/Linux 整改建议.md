- 整改脚本 `security_3.sh`
- ```bash
  #!/usr/bin/env bash
  # Author: Acdiost
  # Date: 2022-03-16
  # Description: 根据《信息安全技术网络安全等级保护基本要求（GB/T 22239-2019）》的安全基线检查整改
  # Version: 1.0
  # curl -sSL https://gist.githubusercontent.com/acdiost/509336ffa8ea49ef884784754fc1c87f/raw/5291ec4efa251bc8599ad10ee345117c7c5611a7/security_3.sh | bash
  
  
  red() {
      echo -e "\e[31m${1}\e[0m"
  }
  
  function init_config(){
  # 设置终端超时时间
  echo 'TMOUT=1800' >> /etc/profile
  
  # 对通过网络进行管理的终端进行限制。
  echo 'ALL: 0.0.0.0/0' >> /etc/hosts.allow
  echo 'ALL: ALL' >> /etc/hosts.deny
  
  # 移除无关应用
  yum remove -y NetworkManager avahi-daemon Bluetooth firstboot Kdump wdaemon wpa_supplicant ypbind
  }
  
  
  function log_config(){
  # 开启日志审计
  yum -y install audit
  
  # 配置审计规则
  cat > /etc/audit/rules.d/audit.rules <<EOF
  ## First rule - delete all
  -D
  
  ## Increase the buffers to survive stress events.
  ## Make this bigger for busy systems
  -b 8192
  
  ## Set failure mode to syslog
  -f 1
  
  -a always,exit -F arch=b64 -S unlink -S unlinkat -S rename -S renameat -F auid>=1000 -F auid!=4294967295 -k delete
  -a always,exit -F arch=b32 -S unlink -S unlinkat -S rename -S renameat -F auid>=1000 -F auid!=4294967295 -k delete
  
  -w /etc/group -p wa -k identity
  -w /etc/passwd -p wa -k identity
  -w /etc/gshadow -p wa -k identity
  -w /etc/shadow -p wa -k identity
  -w /etc/security/opasswd -p wa -k identity
  
  -w /etc/sudoers -p wa -k scope
  -w /etc/sudoers.d/ -p wa -k scope
  EOF
  
  cat > /etc/audit/auditd.conf <<EOF
  ## This file is automatically generated from /etc/audit/rules.d
  -D
  -b 8192
  -f 1
  -a always,exit -F arch=b64 -S unlink -S unlinkat -S rename -S renameat -F auid>=1000 -F auid!=4294967295 -k delete
  -a always,exit -F arch=b32 -S unlink -S unlinkat -S rename -S renameat -F auid>=1000 -F auid!=4294967295 -k delete
  -w /etc/group -p wa -k identity
  -w /etc/passwd -p wa -k identity
  -w /etc/gshadow -p wa -k identity
  -w /etc/shadow -p wa -k identity
  -w /etc/security/opasswd -p wa -k identity
  -w /etc/sudoers -p wa -k scope
  -w /etc/sudoers.d/ -p wa -k scope
  EOF
  
  cat > /etc/logrotate.conf <<EOF
  # 保存一年
  monthly
  rotate 12
  create
  dateext
  include /etc/logrotate.d
  # 存放用户登录的信息
  /var/log/wtmp {
    monthly
    create 0644 root utmp
        minsize 1M
    rotate 6
  }
  # 存放用户登录失败的信息
  /var/log/btmp {
    missingok
    monthly
    create 0600 root utmp
    rotate 6
  }
  EOF
  
  # 日志权限不得大于 640
  chmod 640 /var/log/audit/audit.log
  chmod 640 /var/log/messages
  chmod 640 /var/log/secure
  
  # 启动服务
  systemctl enable auditd --now
  systemctl enable rsyslog --now
  }
  
  function user_config(){
  # 设置用户权限配置文件的权限
  chown root:root /etc/passwd /etc/group /etc/shadow /etc/gshadow
  chmod 0644 /etc/group
  chmod 0644 /etc/passwd
  chmod 0640 /etc/shadow
  chmod 0640 /etc/gshadow
  
  # 配置登录限制
  cat > /etc/login.defs <<EOF
  #
  # Please note that the parameters in this configuration file control the
  # behavior of the tools from the shadow-utils component. None of these
  # tools uses the PAM mechanism, and the utilities that use PAM (such as the
  # passwd command) should therefore be configured elsewhere. Refer to
  # /etc/pam.d/system-auth for more information.
  #
  
  # *REQUIRED*
  #   Directory where mailboxes reside, _or_ name of file, relative to the
  #   home directory.  If you _do_ define both, MAIL_DIR takes precedence.
  #   QMAIL_DIR is for Qmail
  #
  #QMAIL_DIR    Maildir
  MAIL_DIR    /var/spool/mail
  #MAIL_FILE    .mail
  
  # Password aging controls:
  #
  #    PASS_MAX_DAYS    Maximum number of days a password may be used.
  #    PASS_MIN_DAYS    Minimum number of days allowed between password changes.
  #    PASS_MIN_LEN    Minimum acceptable password length.
  #    PASS_WARN_AGE    Number of days warning given before a password expires.
  #
  PASS_MAX_DAYS    90
  PASS_MIN_DAYS    7
  PASS_MIN_LEN    10
  PASS_WARN_AGE    7
  
  #
  # Min/max values for automatic uid selection in useradd
  #
  UID_MIN                  1000
  UID_MAX                 60000
  # System accounts
  SYS_UID_MIN               201
  SYS_UID_MAX               999
  
  #
  # Min/max values for automatic gid selection in groupadd
  #
  GID_MIN                  1000
  GID_MAX                 60000
  # System accounts
  SYS_GID_MIN               201
  SYS_GID_MAX               999
  
  #
  # If defined, this command is run when removing a user.
  # It should remove any at/cron/print jobs etc. owned by
  # the user to be removed (passed as the first argument).
  #
  #USERDEL_CMD    /usr/sbin/userdel_local
  
  #
  # If useradd should create home directories for users by default
  # On RH systems, we do. This option is overridden with the -m flag on
  # useradd command line.
  #
  CREATE_HOME    yes
  
  # The permission mask is initialized to this value. If not specified, 
  # the permission mask will be initialized to 022.
  UMASK           077
  
  # This enables userdel to remove user groups if no members exist.
  #
  USERGROUPS_ENAB yes
  
  # Use SHA512 to encrypt password.
  ENCRYPT_METHOD SHA512
  EOF
  
  cat > /etc/security/pwquality.conf <<EOF
  # Configuration for systemwide password quality limits
  # Defaults:
  #
  # Number of characters in the new password that must not be present in the
  # old password.
  # difok = 5
  #
  # Minimum acceptable size for the new password (plus one if
  # credits are not disabled which is the default). (See pam_cracklib manual.)
  # Cannot be set to lower value than 6.
  minlen=10
  #
  # The maximum credit for having digits in the new password. If less than 0
  # it is the minimum number of digits in the new password.
  dcredit=-1
  #
  # The maximum credit for having uppercase characters in the new password.
  # If less than 0 it is the minimum number of uppercase characters in the new
  # password.
  ucredit=-1
  #
  # The maximum credit for having lowercase characters in the new password.
  # If less than 0 it is the minimum number of lowercase characters in the new
  # password.
  lcredit=-1
  #
  # The maximum credit for having other characters in the new password.
  # If less than 0 it is the minimum number of other characters in the new
  # password.
  ocredit=-1
  #
  # The minimum number of required classes of characters for the new
  # password (digits, uppercase, lowercase, others).
  minclass=3
  #
  # The maximum number of allowed consecutive same characters in the new password.
  # The check is disabled if the value is 0.
  # maxrepeat = 0
  #
  # The maximum number of allowed consecutive characters of the same class in the
  # new password.
  # The check is disabled if the value is 0.
  # maxclassrepeat = 0
  #
  # Whether to check for the words from the passwd entry GECOS string of the user.
  # The check is enabled if the value is not 0.
  # gecoscheck = 0
  #
  # Path to the cracklib dictionaries. Default is to use the cracklib default.
  # dictpath =
  EOF
  
  cat > /etc/pam.d/system-auth <<EOF
  #%PAM-1.0
  # This file is auto-generated.
  # User changes will be destroyed the next time authconfig is run.
  auth        required      pam_tally2.so onerr=fail audit silent deny=5 unlock_time=600
  auth        required      pam_env.so
  auth        required      pam_faildelay.so delay=2000000
  auth        sufficient    pam_unix.so nullok try_first_pass
  auth        requisite     pam_succeed_if.so uid >= 1000 quiet_success
  auth        required      pam_deny.so
  
  account     required      pam_unix.so no_pass_expiry
  account     sufficient    pam_localuser.so
  account     sufficient    pam_succeed_if.so uid < 1000 quiet
  account     required      pam_permit.so
  
  password    requisite     pam_pwquality.so try_first_pass local_users_only retry=3 authtok_type=
  password    sufficient    pam_unix.so sha512 shadow nullok try_first_pass use_authtok remember=24
  password    required      pam_deny.so
  
  session     optional      pam_keyinit.so revoke
  session     required      pam_limits.so
  -session    optional      pam_systemd.so
  session     [success=1 default=ignore] pam_succeed_if.so service in crond quiet use_uid
  session     required      pam_unix.so
  EOF
  
  # 确保三个账户存在
  # chmod 750 /home/* # 若有应用在此目录下会导致在该目录下的部分程序异常
  useradd dawn
  usermod -G dawn dawn
  echo "dawn:Dawn@1234." | chpasswd
  useradd audit
  usermod -G audit audit
  echo "audit:Audit@1234" | chpasswd
  useradd security 
  usermod -G security security
  echo "security:Security@1234" | chpasswd
  
  # 使用 su 命令
  users="root,dawn,audit,security"
  wheel_Str="wheel:x:10"
  wheel_Num=($(cat /etc/group | awk -F ':' '{if($1 == "wheel")print NR}'))
  if [ -n "$wheel_Num" ]; then
     sed -i "${wheel_Num} c ${wheel_Str}:${users}" /etc/group
  fi
  
  # 修改账户过期时间
  chage --maxdays 90 root
  chage --mindays 7 root
  usermod -L shutdown
  usermod -L halt
  
  red '查看是否存在空口令用户，未列出则无'
  awk -F: 'length($2)==2 {print $1}' /etc/shadow
  
  red '确保 root 是唯一的 UID 为 0 的帐户，未列出则无'
  cat /etc/passwd | awk -F: '($3 == 0) { print $1 }'|grep -v '^root$'
  }
  
  
  function ssh_config(){
  cat > /etc/ssh/sshd_config <<EOF
  # $OpenBSD: sshd_config,v 1.100 2016/08/15 12:32:04 naddy Exp $
  
  # This is the sshd server system-wide configuration file.  See
  # sshd_config(5) for more information.
  
  # This sshd was compiled with PATH=/usr/local/bin:/usr/bin
  
  # The strategy used for options in the default sshd_config shipped with
  # OpenSSH is to specify options with their default value where
  # possible, but leave them commented.  Uncommented options override the
  # default value.
  
  # If you want to change the port on a SELinux system, you have to tell
  # SELinux about this change.
  # semanage port -a -t ssh_port_t -p tcp #PORTNUMBER
  #
  #Port 22
  #AddressFamily any
  #ListenAddress 0.0.0.0
  #ListenAddress ::
  
  HostKey /etc/ssh/ssh_host_rsa_key
  #HostKey /etc/ssh/ssh_host_dsa_key
  HostKey /etc/ssh/ssh_host_ecdsa_key
  HostKey /etc/ssh/ssh_host_ed25519_key
  
  # Ciphers and keying
  #RekeyLimit default none
  
  # Logging
  #SyslogFacility AUTH
  
  LogLevel INFO
  
  # Authentication:
  
  #LoginGraceTime 2m
  #PermitRootLogin yes
  #StrictModes yes
  MaxAuthTries 5
  #MaxSessions 10
  
  #PubkeyAuthentication yes
  
  # The default is to check both .ssh/authorized_keys and .ssh/authorized_keys2
  # but this is overridden so installations will only check .ssh/authorized_keys
  AuthorizedKeysFile    .ssh/authorized_keys
  
  #AuthorizedPrincipalsFile none
  
  #AuthorizedKeysCommand none
  #AuthorizedKeysCommandUser nobody
  
  # For this to work you will also need host keys in /etc/ssh/ssh_known_hosts
  #HostbasedAuthentication no
  # Change to yes if you don't trust ~/.ssh/known_hosts for
  # HostbasedAuthentication
  #IgnoreUserKnownHosts no
  # Don't read the user's ~/.rhosts and ~/.shosts files
  #IgnoreRhosts yes
  
  # To disable tunneled clear text passwords, change to no here!
  PermitEmptyPasswords no
  
  
  # Change to no to disable s/key passwords
  #ChallengeResponseAuthentication yes
  ChallengeResponseAuthentication no
  
  # Kerberos options
  #KerberosAuthentication no
  #KerberosOrLocalPasswd yes
  #KerberosTicketCleanup yes
  #KerberosGetAFSToken no
  #KerberosUseKuserok yes
  
  # GSSAPI options
  GSSAPIAuthentication yes
  GSSAPICleanupCredentials no
  #GSSAPIStrictAcceptorCheck yes
  #GSSAPIKeyExchange no
  #GSSAPIEnablek5users no
  
  # Set this to 'yes' to enable PAM authentication, account processing,
  # and session processing. If this is enabled, PAM authentication will
  # be allowed through the ChallengeResponseAuthentication and
  # PAM authentication via ChallengeResponseAuthentication may bypass
  # the setting of "PermitRootLogin without-password".
  # If you just want the PAM account and session checks to run without
  # and ChallengeResponseAuthentication to 'no'.
  # WARNING: 'UsePAM no' is not supported in Red Hat Enterprise Linux and may cause several
  # problems.
  UsePAM yes
  
  #AllowAgentForwarding yes
  #AllowTcpForwarding yes
  #GatewayPorts no
  X11Forwarding yes
  #X11DisplayOffset 10
  #X11UseLocalhost yes
  #PermitTTY yes
  #PrintMotd yes
  #PrintLastLog yes
  #TCPKeepAlive yes
  #UseLogin no
  #UsePrivilegeSeparation sandbox
  #PermitUserEnvironment no
  #Compression delayed
  ClientAliveInterval 600
  ClientAliveCountMax 3
  #ShowPatchLevel no
  #UseDNS yes
  #PidFile /var/run/sshd.pid
  #MaxStartups 10:30:100
  #PermitTunnel no
  #ChrootDirectory none
  #VersionAddendum none
  
  # no default banner path
  #Banner none
  
  # Accept locale-related environment variables
  AcceptEnv LANG LC_CTYPE LC_NUMERIC LC_TIME LC_COLLATE LC_MONETARY LC_MESSAGES
  AcceptEnv LC_PAPER LC_NAME LC_ADDRESS LC_TELEPHONE LC_MEASUREMENT
  AcceptEnv LC_IDENTIFICATION LC_ALL LANGUAGE
  AcceptEnv XMODIFIERS
  
  # override default of no subsystems
  Subsystem    sftp    /usr/libexec/openssh/sftp-server
  
  # Example of overriding settings on a per-user basis
  #Match User anoncvs
  #    X11Forwarding no
  #    AllowTcpForwarding no
  #    PermitTTY no
  #    ForceCommand cvs server
  
  UseDNS no
  AddressFamily inet
  SyslogFacility AUTHPRIV
  PermitRootLogin no
  PasswordAuthentication yes
  EOF
  
  cat > /etc/pam.d/sshd <<EOF
  #%PAM-1.0
  auth       required pam_tally2.so deny=5 even_deny_root unlock_time=900 root_unlock_time=900
  auth       required     pam_sepermit.so
  auth       substack     password-auth
  auth       include      postlogin
  # Used with polkit to reauthorize users in remote sessions
  -auth      optional     pam_reauthorize.so prepare
  account    required     pam_nologin.so
  account    include      password-auth
  password   include      password-auth
  # pam_selinux.so close should be the first session rule
  session    required     pam_selinux.so close
  session    required     pam_loginuid.so
  # pam_selinux.so open should only be followed by sessions to be executed in the user context
  session    required     pam_selinux.so open env_params
  session    required     pam_namespace.so
  session    optional     pam_keyinit.so force revoke
  session    include      password-auth
  session    include      postlogin
  # Used with polkit to reauthorize users in remote sessions
  -session   optional     pam_reauthorize.so prepare
  EOF
  
  systemctl restart sshd
  }
  
  function kernel_config(){
  cat > /etc/sysctl.conf <<EOF
  vm.swappiness = 0
  
  kernel.sysrq = 1
  kernel.hung_task_timeout_secs = 240
  kernel.panic_on_oops = 1
  kernel.watchdog_thresh = 50
  kernel.hardlockup_panic = 1
  kernel.unprivileged_bpf_disabled = 1
  
  net.ipv4.neigh.default.gc_stale_time = 120
  
  net.ipv4.conf.all.rp_filter = 0
  net.ipv4.conf.default.rp_filter = 0
  net.ipv4.conf.default.arp_announce = 2
  net.ipv4.conf.lo.arp_announce = 2
  net.ipv4.conf.all.arp_announce = 2
  
  net.ipv4.tcp_max_tw_buckets = 262144
  net.ipv4.tcp_syncookies = 1
  
  # tcp_max_syn_backlog will only take effect when net.ipv4.tcp_syncookies == 0
  # net.ipv4.tcp_max_syn_backlog = 65536
  net.ipv4.tcp_synack_retries = 2
  net.ipv4.tcp_slow_start_after_idle = 0
  
  net.bridge.bridge-nf-call-iptables = 1
  net.bridge.bridge-nf-call-ip6tables = 1
  EOF
  
  sysctl -p
  }
  
  
  function firewall_config(){
  systemctl enable firewalld --now
  
  # 关闭不需要的端口: 21、23、25、111、427、631
  # ss -ntl4 | egrep ':21|:23|:25|:111|:427|:631' | awk '{print $4}' | cut -d: -f2 | xargs -r iptables -I INPUT -p tcp --dport {} -j DROP
  ss -ntl4 | egrep ':21|:23|:25|:111|:427|:631' | awk '{print $4}' | cut -d: -f2 | xargs -r firewall-cmd --permanent --zone=public --remove-port={}/tcp
  
  # 添加服务
  firewall-cmd --add-service=ssh --permanent --zone=public
  firewall-cmd --add-service=http --permanent --zone=public
  firewall-cmd --add-service=https --permanent --zone=public
  # 添加端口
  # firewall-cmd --add-port=8080/tcp --permanent --zone=public
  # 添加端口段
  # firewall-cmd --add-port=8081-8090/tcp --permanent --zone=public
  # 添加网段访问指定端口
  # firewall-cmd --add-rich-rule='rule family="ipv4" source address="192.168.1.0/24" port port="8080" protocol="tcp" accept' --permanent --zone=public
  # 添加可信 IP
  # firewall-cmd --add-source=192.168.1.2/32 --permanent --zone=trusted
  # 添加可信 IP 段
  # firewall-cmd --add-source=192.168.1.0/24 --permanent --zone=trusted
  firewall-cmd --reload
  firewall-cmd --list-all
  }
  
  
  # 安装防恶意代码软件
  function install_clamav(){
  yum install -y epel-release
  yum install -y clamav clamd clamav-update
  systemctl enable clamav-freshclam.service --now
  }
  
  
  function main(){
      init_config
      log_config
      ssh_config
      kernel_config
      firewall_config
      install_clamav
      user_config
  }
  
  main
  ```
- 修改 `/etc/login.defs` 文件
  ```bash
  # 密码最大有效期
  PASS_MAX_DAYS   90
  # 两次修改密码的最小间隔时间
  PASS_MIN_DAYS   1
  # 密码最小长度，对于root无效
  PASS_MIN_LEN    8
  # 密码过期前 7 天开始提示
  PASS_WARN_AGE   7
  ```
- 密码的强度要求 `/etc/pam.d/system-auth`
  ```bash
  # remember=5 5次内密码不重复
  # retry=3 输入错误重试3次
  # difok=4 至少要有4个字符不会出现在老口令中
  # minlen=10表示最小密码长度为 10 类型数量
  # ucredit=-1 表示密码必须至少包含 1 个大写字母
  # lcredit=-3 表示密码必须至少包含 3 个小写字母
  # dcredit=-3 表示密码必须至少包含 3 个数字
  password    requisite     pam_cracklib.so retry=5 difok=4 minlen=10 ucredit=-1 lcredit=-3 dcredit=-3 dictpath=/usr/share/cracklib/pw_dict
  
  # 密码错误 5 次锁定 1800 秒
  auth        required      pam_tally2.so onerr=fail deny=5 unlock_time=1800 even_deny_root root_unlock_time=1800
  ```
- 会话过期 `/etc/profile`
  ```bash
  export TMOUT=1800
  ```
- 登录地址限制 `/etc/hosts.deny`
  ```bash
  sshd:ALL
  ```
   `/etc/hosts.allow`
  ```bash
  # 允许某台访问 ssh
  sshd:192.168.1.2
  # 允许某个网段访问 ssh
  sshd:192.168.2.
  # 允许访问 telnet 
  in.telnetd:192.168.3.
  ```
- 关闭不需要的系统服务、默认共享和高危端口
- 遵循最小安装的原则，仅安装需要的组件和应用程序
- 删除或停用多余的、过期的账户，避免共享账户存在
